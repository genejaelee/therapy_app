var chatsModule = angular.module('chatsModule');

chatsModule.factory('jsonMethods', function($http){
	return {
		makeJson: function(msg, nickname) {
			var chat_user_id = parseInt(user_id);
			var chat_id = parseInt(chat_id)
			
			messageObject = {
				"message": {
					"chat_id": chat_id,
					"channel": channel,
					"user": {
						"id" : chat_user_id,
						"nickname" : nickname
					},
					"text": msg
				}
			};
			return messageObject;
		},
		
		postDoc: function(json) {
			vaultID = '<%= ENV['TV_A_VAULT_ID'] %>'
			apiKey = '<%= ENV['TV_API_KEY'] %>'
			console.log(JSON.stringify(json));
			var promise = $http({
				method: 'POST', 
				headers: { 'Authorization' : 'Basic ' + btoa(apiKey + ":") },
				url: 'https://api.truevault.com/v1/vaults/' + vaultID + '/documents',
				data: { document : btoa(JSON.stringify(json)) }
			}).then(function(response){
				return response.data;
		  },
			function(response) {
				console.log(response);
			});
			return promise;
		}
		
	}
});

chatsModule.factory('chatMethods', function($http, $timeout){
	return {
		getDocByID: function(id) {
			console.log("id is " + id);
			vaultID = '<%= ENV['TV_A_VAULT_ID'] %>'
			apiKey = '<%= ENV['TV_API_KEY'] %>'
			var promise = $http({
				method: 'GET',
				headers: { 'Authorization' : 'Basic ' + btoa(apiKey + ":") },
				url: 'https://api.truevault.com/v1/vaults/' + vaultID + '/documents/' + id
			}).then(function(response){
				return response.data;
		  },
			function(response) {
				console.log(response);
			});
			return promise;
		},
		
		triggerSendMessage: function(message, channel, callback) {
			var triggered = channel.trigger('client-send_message', message);
			callback(false);
		},
		
		triggerTypingStatus: function(nickname, status, channel) {
			payload = {
				"nickname": nickname,
				"status": status
			}
			var triggered = channel.trigger('client-typing_status', payload);
		},
		
		appendMessage: function(scope, message, callback) {
			scope.messages.push(message);
			callback(false);
		},
		
		bindPusherEvents: function(scope){
			// Binding Pusher chat events
			scope.channel.bind('client-send_message', function(message){
				scope.messages.push(message);
		
				// Programatically create an audio element and pop the user
				var pop = new Audio('/sounds/pop.wav');
				pop.load();
				pop.play();
		
				scope.$apply();
			});
		
			scope.channel.bind('client-typing_status', function(notification){
				if(notification.status == true) {
					notification.message = "is typing...";
					scope.notification = notification;
				}
				else {
					notification.message = "";
					scope.notification.status = false;
				}
				scope.$apply();
			});
	
			scope.channel.bind('presence', function(member){
				if (member.event == "member_added") {
					member.message = "joined the chatroom."
				}
				else if (member.event == "member_removed") {
					member.message = "left the chatroom."
				}
				member.status = true;
				scope.notification = member;
				scope.notification.timeout = $timeout(function(){
					scope.notification.status = false;
				}, 2000);
				scope.$apply();
			});
		}
	
	}
});

chatsModule.factory('timerMethods', function($http){
	return {
		bindTimerEvents: function(scope){
			scope.channel.bind('client-timer_start', function(payload){
				scope.timer.start();
				scope.$apply();
			});
			
			scope.channel.bind('client-timer_stop', function(payload){
				scope.timer.stop();
				scope.$apply();
			});
			
			scope.channel.bind('client-timer_resume', function(payload){
				scope.timer.resume();
				scope.$apply();
			});
		},
		
		triggerStartTimer: function(timer, channel, callback) {
			var triggered = channel.trigger('client-timer_start', payload);
			callback();
		},
		triggerStopTimer: function(timer, channel, callback) {
			var triggered = channel.trigger('client-timer_stop', payload);
			callback();
		},
		triggerResumeTimer: function(timer, channel, callback) {
			var triggered = channel.trigger('client-timer_resume', payload);
			callback();
		}
	}
});

chatsModule.controller('ChatsViewCtrl', function($scope, jsonMethods, chatMethods, timerMethods, $http, $timeout, Pusher, PusherMethods) {
	$scope.current = { nickname : user_nickname };
	$scope.timer = document.getElementById('timer').getElementsByTagName('timer')[0];
	console.log($scope.current.nickname);
	
	$scope.popup = { close : false };
	$scope.closePopup = function(){
		if ($scope.isCheckedN) {
			$scope.popup.close = true;
		}
		else {
			alert('You must accept the conditions to proceed.');
		}
	}
	
	$scope.messageSending = false;
	$scope.message_text = '';
	$scope.typing_status = false;
	
	PusherMethods.setAuthEndpoint();
	$scope.pusher = PusherMethods.pusher();
	$scope.channel = PusherMethods.channel($scope.pusher);
	
	$scope.messages = [];
	$scope.notifications = [];
	$scope.checkSender = function(id){
		if (user_id == id){
			var sender = "you";
		}
		else {
			var sender = "them";
		}
		return sender;
	}
	
	// TIMER API STUFF
	
	timerMethods.bindTimerEvents($scope);
	
	$scope.stopResumeTimer = function(btn) {
	  if (btn.innerHTML === 'Start') {
			timerMethods.triggerStartTimer(timer, $scope.channel, function(){
				$scope.timer.start();
			});
	    btn.innerHTML = 'Stop';
	  }
	  else if (btn.innerHTML === 'Stop') {
			timerMethods.triggerStopTimer(timer, $scope.channel, function(){
				$scope.timer.stop();
			});
	    btn.innerHTML = 'Resume';
	  }
	  else {
			timerMethods.triggerResumeTimer(timer, $scope.channel, function(){
				$scope.timer.resume();
			});
	    btn.innerHTML = 'Stop';
	  }
	}
	
	// PUSHER API STUFF
	
	chatMethods.bindPusherEvents($scope);
	
	$scope.$watch('message_text', function(){
		var nickname = $scope.current.nickname;
		var status = $scope.typing_status;
		var channel = $scope.channel;
		if ((($scope.message_text + '').length >= 1) && (status == false)) {
			console.log('typing');
			status = true;
			chatMethods.triggerTypingStatus(nickname, status, channel);
		} else if (($scope.message_text + '').length == 0) {
			console.log('not typing')
			status = false;
			chatMethods.triggerTypingStatus(nickname, status, channel);
		}
	});

	$scope.postMessage = function(){
		$scope.messageSending = true;
		var msg = $scope.message_text
		if(msg == null || msg == "") {
			alert('Please enter a message...');
		}
		else {
			var json = jsonMethods.makeJson(msg, $scope.current.nickname);
			jsonMethods.postDoc(json).
			then(function(promise){
				console.log('promise is ' + JSON.stringify(promise));
				var id = promise.document_id;
				return chatMethods.getDocByID(id);
			}).
			then(function(promise){
				decoded = JSON.parse(atob(promise));
				message = decoded.message;
				chatMethods.triggerSendMessage(message, $scope.channel, function(bool){
					$scope.messageSending = bool;
				});
				chatMethods.appendMessage($scope, message, function(bool){
					$scope.messageSending = bool;
					$scope.message_text = "";
				});
			});
		}
	}
});